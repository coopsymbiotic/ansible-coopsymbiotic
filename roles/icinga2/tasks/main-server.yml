---

# nb: nagios-plugins-contrib is required for check_ssl_cert
- apt: name={{ item }} state=present install_recommends=no
  with_items:
    - icinga2
    - icinga2-ido-mysql
    - nsca-ng-server
    - monitoring-plugins
    - monitoring-plugins-basic
    - monitoring-plugins-common
    - monitoring-plugins-standard
    - nagios-plugins-contrib
  tags:
    - packages

- name: Make sure we have a TicketSalt in constants.conf
  replace: dest=/etc/icinga2/constants.conf regexp='const TicketSalt = ""' replace='const TicketSalt = "{{ icinga2_ticket_salt }}"'

- name: Enable command feature for icingaweb2
  file: src=/etc/icinga2/features-available/command.conf dest=/etc/icinga2/features-enabled/command.conf state=link
  notify: restart icinga2

- name: Ensure that the nsca-ng directory exists
  file: path=/var/run/nsca-ng state=directory owner=nagios group=nagios mode=0775

- name: Permissions on ido-mysql.conf file
  file: path=/etc/icinga2/features-available/ido-mysql.conf owner=root group=nagios mode=0640

# TODO : ufw open 5668 tcp for NRPE

- name: Open the Icinga2 port for our machines only (used for ssl and node communication)
  ufw: proto=tcp port=5665 rule=allow src={{ item }}
  with_items: icinga2_allow_ips

# TODO : run pki new-ca ?

# NB: not using "inventory_hostname" because in our case,
# it is usually a machine name ("sillyname.example.net"), but we name our CA "icinga.example.org".
- name: Run icinga2 pki new-cert for our host
  shell: icinga2 pki new-cert --cn {{Â icinga2_main_node }} --key /etc/icinga2/pki/{{ icinga2_main_node }}.key --cert /etc/icinga2/pki/{{ icinga2_main_node }}.crt
  args:
    creates: /etc/icinga2/pki/{{ icinga2_main_node }}.key
